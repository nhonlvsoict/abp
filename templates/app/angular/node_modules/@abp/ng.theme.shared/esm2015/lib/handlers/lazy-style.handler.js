import { getLocaleDirection, LazyLoadService, LOADING_STRATEGY, LocalizationService, } from '@abp/ng.core';
import { Injectable, Injector } from '@angular/core';
import { startWith } from 'rxjs/operators';
import { BOOTSTRAP } from '../constants/styles';
import { LAZY_STYLES } from '../tokens/lazy-styles.token';
import * as i0 from "@angular/core";
export class LazyStyleHandler {
    constructor(injector) {
        this._dir = 'ltr';
        this.loaded = new Map();
        this.setStyles(injector);
        this.setLazyLoad(injector);
        this.listenToLanguageChanges(injector);
    }
    set dir(dir) {
        if (dir === this._dir)
            return;
        this.switchCSS(dir);
        this.setBodyDir(dir);
        this._dir = dir;
    }
    get dir() {
        return this._dir;
    }
    getHrefFromLink(link) {
        if (!link)
            return '';
        const a = document.createElement('a');
        a.href = link.href;
        return a.pathname.replace(/^\//, '');
    }
    getLoadedBootstrap() {
        const href = createLazyStyleHref(BOOTSTRAP, this.dir);
        const selector = `[href*="${href.replace(/\.css$/, '')}"]`;
        const link = document.querySelector(selector);
        return { href, link };
    }
    listenToLanguageChanges(injector) {
        const l10n = injector.get(LocalizationService);
        // will always listen, no need to unsubscribe
        l10n.languageChange$.pipe(startWith(l10n.currentLang)).subscribe(locale => {
            this.dir = getLocaleDirection(locale);
        });
    }
    setBodyDir(dir) {
        document.body.dir = dir;
    }
    setLazyLoad(injector) {
        this.lazyLoad = injector.get(LazyLoadService);
        const { href, link } = this.getLoadedBootstrap();
        this.lazyLoad.loaded.set(href, link);
    }
    setStyles(injector) {
        this.styles = injector.get(LAZY_STYLES, [BOOTSTRAP]);
    }
    switchCSS(dir) {
        this.styles.forEach(style => {
            const oldHref = createLazyStyleHref(style, this.dir);
            const newHref = createLazyStyleHref(style, dir);
            const link = this.loaded.get(newHref);
            const href = this.getHrefFromLink(link) || newHref;
            const strategy = LOADING_STRATEGY.PrependAnonymousStyleToHead(href);
            this.lazyLoad.load(strategy).subscribe(() => {
                const oldLink = this.lazyLoad.loaded.get(oldHref);
                this.loaded.delete(newHref);
                this.loaded.set(oldHref, oldLink);
                const newLink = this.lazyLoad.loaded.get(href);
                this.lazyLoad.loaded.delete(href);
                this.lazyLoad.loaded.set(newHref, newLink);
                this.lazyLoad.remove(oldHref);
            });
        });
    }
}
LazyStyleHandler.ɵprov = i0.ɵɵdefineInjectable({ factory: function LazyStyleHandler_Factory() { return new LazyStyleHandler(i0.ɵɵinject(i0.INJECTOR)); }, token: LazyStyleHandler, providedIn: "root" });
LazyStyleHandler.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
LazyStyleHandler.ctorParameters = () => [
    { type: Injector }
];
export function createLazyStyleHref(style, dir) {
    return style.replace(/{{\s*dir\s*}}/g, dir);
}
export function initLazyStyleHandler(injector) {
    return () => new LazyStyleHandler(injector);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGF6eS1zdHlsZS5oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvdGhlbWUtc2hhcmVkL3NyYy9saWIvaGFuZGxlcnMvbGF6eS1zdHlsZS5oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxrQkFBa0IsRUFDbEIsZUFBZSxFQUNmLGdCQUFnQixFQUNoQixtQkFBbUIsR0FDcEIsTUFBTSxjQUFjLENBQUM7QUFDdEIsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFPLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUVoRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sNkJBQTZCLENBQUM7O0FBSzFELE1BQU0sT0FBTyxnQkFBZ0I7SUFtQjNCLFlBQVksUUFBa0I7UUFoQnRCLFNBQUksR0FBb0IsS0FBSyxDQUFDO1FBRTdCLFdBQU0sR0FBRyxJQUFJLEdBQUcsRUFBMkIsQ0FBQztRQWVuRCxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3pCLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDM0IsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFoQkQsSUFBSSxHQUFHLENBQUMsR0FBb0I7UUFDMUIsSUFBSSxHQUFHLEtBQUssSUFBSSxDQUFDLElBQUk7WUFBRSxPQUFPO1FBRTlCLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDcEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQztJQUNsQixDQUFDO0lBRUQsSUFBSSxHQUFHO1FBQ0wsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFRTyxlQUFlLENBQUMsSUFBNEI7UUFDbEQsSUFBSSxDQUFDLElBQUk7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUVyQixNQUFNLENBQUMsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RDLENBQUMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNuQixPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRU8sa0JBQWtCO1FBQ3hCLE1BQU0sSUFBSSxHQUFHLG1CQUFtQixDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEQsTUFBTSxRQUFRLEdBQUcsV0FBVyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDO1FBQzNELE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQWtCLFFBQVEsQ0FBQyxDQUFDO1FBQy9ELE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUVPLHVCQUF1QixDQUFDLFFBQWtCO1FBQ2hELE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUUvQyw2Q0FBNkM7UUFDN0MsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN4RSxJQUFJLENBQUMsR0FBRyxHQUFHLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLFVBQVUsQ0FBQyxHQUFvQjtRQUNyQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7SUFDMUIsQ0FBQztJQUVPLFdBQVcsQ0FBQyxRQUFrQjtRQUNwQyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDOUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUNqRCxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFTyxTQUFTLENBQUMsUUFBa0I7UUFDbEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVPLFNBQVMsQ0FBQyxHQUFvQjtRQUNwQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUMxQixNQUFNLE9BQU8sR0FBRyxtQkFBbUIsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3JELE1BQU0sT0FBTyxHQUFHLG1CQUFtQixDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNoRCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN0QyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxJQUFJLE9BQU8sQ0FBQztZQUVuRCxNQUFNLFFBQVEsR0FBRyxnQkFBZ0IsQ0FBQywyQkFBMkIsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNwRSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFO2dCQUMxQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFvQixDQUFDO2dCQUNyRSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDNUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUNsQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFvQixDQUFDO2dCQUNsRSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2xDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQzNDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2hDLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOzs7O1lBcEZGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7O1lBUm9CLFFBQVE7O0FBNkY3QixNQUFNLFVBQVUsbUJBQW1CLENBQUMsS0FBYSxFQUFFLEdBQVc7SUFDNUQsT0FBTyxLQUFLLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzlDLENBQUM7QUFFRCxNQUFNLFVBQVUsb0JBQW9CLENBQUMsUUFBa0I7SUFDckQsT0FBTyxHQUFHLEVBQUUsQ0FBQyxJQUFJLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzlDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBnZXRMb2NhbGVEaXJlY3Rpb24sXG4gIExhenlMb2FkU2VydmljZSxcbiAgTE9BRElOR19TVFJBVEVHWSxcbiAgTG9jYWxpemF0aW9uU2VydmljZSxcbn0gZnJvbSAnQGFicC9uZy5jb3JlJztcbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBtYXAsIHN0YXJ0V2l0aCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEJPT1RTVFJBUCB9IGZyb20gJy4uL2NvbnN0YW50cy9zdHlsZXMnO1xuaW1wb3J0IHsgTG9jYWxlRGlyZWN0aW9uIH0gZnJvbSAnLi4vbW9kZWxzL2NvbW1vbic7XG5pbXBvcnQgeyBMQVpZX1NUWUxFUyB9IGZyb20gJy4uL3Rva2Vucy9sYXp5LXN0eWxlcy50b2tlbic7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBMYXp5U3R5bGVIYW5kbGVyIHtcbiAgcHJpdmF0ZSBsYXp5TG9hZDogTGF6eUxvYWRTZXJ2aWNlO1xuICBwcml2YXRlIHN0eWxlczogc3RyaW5nW107XG4gIHByaXZhdGUgX2RpcjogTG9jYWxlRGlyZWN0aW9uID0gJ2x0cic7XG5cbiAgcmVhZG9ubHkgbG9hZGVkID0gbmV3IE1hcDxzdHJpbmcsIEhUTUxMaW5rRWxlbWVudD4oKTtcblxuICBzZXQgZGlyKGRpcjogTG9jYWxlRGlyZWN0aW9uKSB7XG4gICAgaWYgKGRpciA9PT0gdGhpcy5fZGlyKSByZXR1cm47XG5cbiAgICB0aGlzLnN3aXRjaENTUyhkaXIpO1xuICAgIHRoaXMuc2V0Qm9keURpcihkaXIpO1xuICAgIHRoaXMuX2RpciA9IGRpcjtcbiAgfVxuXG4gIGdldCBkaXIoKTogTG9jYWxlRGlyZWN0aW9uIHtcbiAgICByZXR1cm4gdGhpcy5fZGlyO1xuICB9XG5cbiAgY29uc3RydWN0b3IoaW5qZWN0b3I6IEluamVjdG9yKSB7XG4gICAgdGhpcy5zZXRTdHlsZXMoaW5qZWN0b3IpO1xuICAgIHRoaXMuc2V0TGF6eUxvYWQoaW5qZWN0b3IpO1xuICAgIHRoaXMubGlzdGVuVG9MYW5ndWFnZUNoYW5nZXMoaW5qZWN0b3IpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRIcmVmRnJvbUxpbmsobGluazogSFRNTExpbmtFbGVtZW50IHwgbnVsbCk6IHN0cmluZyB7XG4gICAgaWYgKCFsaW5rKSByZXR1cm4gJyc7XG5cbiAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xuICAgIGEuaHJlZiA9IGxpbmsuaHJlZjtcbiAgICByZXR1cm4gYS5wYXRobmFtZS5yZXBsYWNlKC9eXFwvLywgJycpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRMb2FkZWRCb290c3RyYXAoKTogTG9hZGVkU3R5bGUge1xuICAgIGNvbnN0IGhyZWYgPSBjcmVhdGVMYXp5U3R5bGVIcmVmKEJPT1RTVFJBUCwgdGhpcy5kaXIpO1xuICAgIGNvbnN0IHNlbGVjdG9yID0gYFtocmVmKj1cIiR7aHJlZi5yZXBsYWNlKC9cXC5jc3MkLywgJycpfVwiXWA7XG4gICAgY29uc3QgbGluayA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3I8SFRNTExpbmtFbGVtZW50PihzZWxlY3Rvcik7XG4gICAgcmV0dXJuIHsgaHJlZiwgbGluayB9O1xuICB9XG5cbiAgcHJpdmF0ZSBsaXN0ZW5Ub0xhbmd1YWdlQ2hhbmdlcyhpbmplY3RvcjogSW5qZWN0b3IpIHtcbiAgICBjb25zdCBsMTBuID0gaW5qZWN0b3IuZ2V0KExvY2FsaXphdGlvblNlcnZpY2UpO1xuXG4gICAgLy8gd2lsbCBhbHdheXMgbGlzdGVuLCBubyBuZWVkIHRvIHVuc3Vic2NyaWJlXG4gICAgbDEwbi5sYW5ndWFnZUNoYW5nZSQucGlwZShzdGFydFdpdGgobDEwbi5jdXJyZW50TGFuZykpLnN1YnNjcmliZShsb2NhbGUgPT4ge1xuICAgICAgdGhpcy5kaXIgPSBnZXRMb2NhbGVEaXJlY3Rpb24obG9jYWxlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Qm9keURpcihkaXI6IExvY2FsZURpcmVjdGlvbikge1xuICAgIGRvY3VtZW50LmJvZHkuZGlyID0gZGlyO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRMYXp5TG9hZChpbmplY3RvcjogSW5qZWN0b3IpIHtcbiAgICB0aGlzLmxhenlMb2FkID0gaW5qZWN0b3IuZ2V0KExhenlMb2FkU2VydmljZSk7XG4gICAgY29uc3QgeyBocmVmLCBsaW5rIH0gPSB0aGlzLmdldExvYWRlZEJvb3RzdHJhcCgpO1xuICAgIHRoaXMubGF6eUxvYWQubG9hZGVkLnNldChocmVmLCBsaW5rKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0U3R5bGVzKGluamVjdG9yOiBJbmplY3Rvcikge1xuICAgIHRoaXMuc3R5bGVzID0gaW5qZWN0b3IuZ2V0KExBWllfU1RZTEVTLCBbQk9PVFNUUkFQXSk7XG4gIH1cblxuICBwcml2YXRlIHN3aXRjaENTUyhkaXI6IExvY2FsZURpcmVjdGlvbikge1xuICAgIHRoaXMuc3R5bGVzLmZvckVhY2goc3R5bGUgPT4ge1xuICAgICAgY29uc3Qgb2xkSHJlZiA9IGNyZWF0ZUxhenlTdHlsZUhyZWYoc3R5bGUsIHRoaXMuZGlyKTtcbiAgICAgIGNvbnN0IG5ld0hyZWYgPSBjcmVhdGVMYXp5U3R5bGVIcmVmKHN0eWxlLCBkaXIpO1xuICAgICAgY29uc3QgbGluayA9IHRoaXMubG9hZGVkLmdldChuZXdIcmVmKTtcbiAgICAgIGNvbnN0IGhyZWYgPSB0aGlzLmdldEhyZWZGcm9tTGluayhsaW5rKSB8fCBuZXdIcmVmO1xuXG4gICAgICBjb25zdCBzdHJhdGVneSA9IExPQURJTkdfU1RSQVRFR1kuUHJlcGVuZEFub255bW91c1N0eWxlVG9IZWFkKGhyZWYpO1xuICAgICAgdGhpcy5sYXp5TG9hZC5sb2FkKHN0cmF0ZWd5KS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICBjb25zdCBvbGRMaW5rID0gdGhpcy5sYXp5TG9hZC5sb2FkZWQuZ2V0KG9sZEhyZWYpIGFzIEhUTUxMaW5rRWxlbWVudDtcbiAgICAgICAgdGhpcy5sb2FkZWQuZGVsZXRlKG5ld0hyZWYpO1xuICAgICAgICB0aGlzLmxvYWRlZC5zZXQob2xkSHJlZiwgb2xkTGluayk7XG4gICAgICAgIGNvbnN0IG5ld0xpbmsgPSB0aGlzLmxhenlMb2FkLmxvYWRlZC5nZXQoaHJlZikgYXMgSFRNTExpbmtFbGVtZW50O1xuICAgICAgICB0aGlzLmxhenlMb2FkLmxvYWRlZC5kZWxldGUoaHJlZik7XG4gICAgICAgIHRoaXMubGF6eUxvYWQubG9hZGVkLnNldChuZXdIcmVmLCBuZXdMaW5rKTtcbiAgICAgICAgdGhpcy5sYXp5TG9hZC5yZW1vdmUob2xkSHJlZik7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlTGF6eVN0eWxlSHJlZihzdHlsZTogc3RyaW5nLCBkaXI6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBzdHlsZS5yZXBsYWNlKC97e1xccypkaXJcXHMqfX0vZywgZGlyKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGluaXRMYXp5U3R5bGVIYW5kbGVyKGluamVjdG9yOiBJbmplY3Rvcikge1xuICByZXR1cm4gKCkgPT4gbmV3IExhenlTdHlsZUhhbmRsZXIoaW5qZWN0b3IpO1xufVxuXG5pbnRlcmZhY2UgTG9hZGVkU3R5bGUge1xuICBocmVmOiBzdHJpbmc7XG4gIGxpbms6IEhUTUxMaW5rRWxlbWVudDtcbn1cbiJdfQ==