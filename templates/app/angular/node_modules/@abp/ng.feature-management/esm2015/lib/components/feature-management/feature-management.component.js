import { AbpApplicationConfigurationService, ConfigStateService, TrackByService, } from '@abp/ng.core';
import { Component, EventEmitter, Input, Output } from '@angular/core';
import { Store } from '@ngxs/store';
import { finalize, tap } from 'rxjs/operators';
import { FeaturesService } from '../../proxy/feature-management/features.service';
var ValueTypes;
(function (ValueTypes) {
    ValueTypes["ToggleStringValueType"] = "ToggleStringValueType";
    ValueTypes["FreeTextStringValueType"] = "FreeTextStringValueType";
    ValueTypes["SelectionStringValueType"] = "SelectionStringValueType";
})(ValueTypes || (ValueTypes = {}));
export class FeatureManagementComponent {
    constructor(track, service, store, configState, appConfigService) {
        this.track = track;
        this.service = service;
        this.store = store;
        this.configState = configState;
        this.appConfigService = appConfigService;
        this.groups = [];
        this.valueTypes = ValueTypes;
        this.visibleChange = new EventEmitter();
        this.modalBusy = false;
    }
    get visible() {
        return this._visible;
    }
    set visible(value) {
        if (this._visible === value)
            return;
        this._visible = value;
        this.visibleChange.emit(value);
        if (value)
            this.openModal();
    }
    openModal() {
        if (!this.providerName) {
            throw new Error('providerName is required.');
        }
        this.getFeatures();
    }
    getFeatures() {
        this.service.get(this.providerName, this.providerKey).subscribe(res => {
            var _a;
            if (!((_a = res.groups) === null || _a === void 0 ? void 0 : _a.length))
                return;
            this.groups = res.groups.map(({ name, displayName }) => ({ name, displayName }));
            this.selectedGroupDisplayName = this.groups[0].displayName;
            this.features = res.groups.reduce((acc, val) => (Object.assign(Object.assign({}, acc), { [val.name]: mapFeatures(val.features, document.body.dir) })), {});
        });
    }
    save() {
        if (this.modalBusy)
            return;
        const changedFeatures = [];
        Object.keys(this.features).forEach(key => {
            this.features[key].forEach(feature => {
                if (feature.value !== feature.initialValue)
                    changedFeatures.push({ name: feature.name, value: `${feature.value}` });
            });
        });
        if (!changedFeatures.length) {
            this.visible = false;
            return;
        }
        this.modalBusy = true;
        this.service
            .update(this.providerName, this.providerKey, { features: changedFeatures })
            .pipe(finalize(() => (this.modalBusy = false)))
            .subscribe(() => {
            this.visible = false;
            if (!this.providerKey) {
                // to refresh host's features
                this.appConfigService
                    .get()
                    .pipe(tap(res => this.configState.setState(res)))
                    .subscribe();
            }
        });
    }
    onCheckboxClick(val, feature) {
        if (val) {
            this.checkToggleAncestors(feature);
        }
        else {
            this.uncheckToggleDescendants(feature);
        }
    }
    uncheckToggleDescendants(feature) {
        this.findAllDescendantsOfByType(feature, ValueTypes.ToggleStringValueType).forEach(node => this.setFeatureValue(node, false));
    }
    checkToggleAncestors(feature) {
        this.findAllAncestorsOfByType(feature, ValueTypes.ToggleStringValueType).forEach(node => this.setFeatureValue(node, true));
    }
    findAllAncestorsOfByType(feature, type) {
        let parent = this.findParentByType(feature, type);
        const ancestors = [];
        while (parent) {
            ancestors.push(parent);
            parent = this.findParentByType(parent, type);
        }
        return ancestors;
    }
    findAllDescendantsOfByType(feature, type) {
        const descendants = [];
        const queue = [feature];
        while (queue.length) {
            const node = queue.pop();
            const newDescendants = this.findChildrenByType(node, type);
            descendants.push(...newDescendants);
            queue.push(...newDescendants);
        }
        return descendants;
    }
    findParentByType(feature, type) {
        return this.getCurrentGroup().find(f => f.valueType.name === type && f.name === feature.parentName);
    }
    findChildrenByType(feature, type) {
        return this.getCurrentGroup().filter(f => f.valueType.name === type && f.parentName === feature.name);
    }
    getCurrentGroup() {
        var _a;
        return (_a = this.features[this.selectedGroupDisplayName]) !== null && _a !== void 0 ? _a : [];
    }
    setFeatureValue(feature, val) {
        feature.value = val;
    }
}
FeatureManagementComponent.decorators = [
    { type: Component, args: [{
                selector: 'abp-feature-management',
                template: "<abp-modal *ngIf=\"visible\" size=\"lg\" [(visible)]=\"visible\" [busy]=\"modalBusy\">\n  <ng-template #abpHeader>\n    <h3>{{ 'AbpFeatureManagement::Features' | abpLocalization }}</h3>\n  </ng-template>\n\n  <ng-template #abpBody>\n    <div class=\"row\">\n      <div class=\"col-md-4\">\n        <ul\n          ngbNav\n          #nav=\"ngbNav\"\n          [(activeId)]=\"selectedGroupDisplayName\"\n          class=\"nav-pills\"\n          orientation=\"vertical\"\n        >\n          <li\n            *ngFor=\"let group of groups; trackBy: track.by('name')\"\n            [ngbNavItem]=\"group.displayName\"\n          >\n            <a ngbNavLink>{{ group.displayName }}</a>\n            <ng-template ngbNavContent>\n              <h4>{{ selectedGroupDisplayName }}</h4>\n              <hr class=\"mt-2 mb-3\" />\n\n              <div\n                class=\"mt-2\"\n                *ngFor=\"let feature of features[group.name]; let i = index; trackBy: track.by('id')\"\n                [ngStyle]=\"feature.style\"\n                [ngSwitch]=\"feature.valueType?.name\"\n                (keyup.enter)=\"save()\"\n              >\n                <ng-container *ngSwitchCase=\"valueTypes.ToggleStringValueType\">\n                  <div class=\"custom-checkbox custom-control\">\n                    <input\n                      class=\"custom-control-input\"\n                      type=\"checkbox\"\n                      [id]=\"feature.name\"\n                      [(ngModel)]=\"feature.value\"\n                      (ngModelChange)=\"onCheckboxClick($event, feature)\"\n                    />\n\n                    <label class=\"custom-control-label\" [htmlFor]=\"feature.name\">{{\n                      feature.displayName\n                    }}</label>\n                    <ng-container\n                      *ngTemplateOutlet=\"descTmp; context: { $implicit: feature.description }\"\n                    ></ng-container>\n                  </div>\n                </ng-container>\n                <ng-container *ngSwitchCase=\"valueTypes.FreeTextStringValueType\">\n                  <div class=\"form-group\">\n                    <label [htmlFor]=\"feature.name\">{{ feature.displayName }}</label>\n                    <input\n                      class=\"form-control\"\n                      type=\"text\"\n                      [id]=\"feature.name\"\n                      [(ngModel)]=\"feature.value\"\n                      [abpFeatureManagementFreeText]=\"feature\"\n                    />\n\n                    <ng-container\n                      *ngTemplateOutlet=\"descTmp; context: { $implicit: feature.description }\"\n                    ></ng-container>\n                  </div>\n                </ng-container>\n                <ng-container *ngSwitchCase=\"valueTypes.SelectionStringValueType\">\n                  <ng-container *ngIf=\"feature.valueType.itemSource?.items?.length\">\n                    <div class=\"form-group\">\n                      <label [htmlFor]=\"feature.name\">{{ feature.displayName }}</label>\n                      <select\n                        class=\"form-control custom-select\"\n                        [id]=\"feature.name\"\n                        [(ngModel)]=\"feature.value\"\n                      >\n                        <option\n                          *ngFor=\"\n                            let item of feature.valueType.itemSource?.items;\n                            trackBy: track.by('value')\n                          \"\n                          [ngValue]=\"item.value\"\n                        >\n                          {{\n                            item.displayText?.resourceName + '::' + item.displayText?.name\n                              | abpLocalization\n                          }}\n                        </option>\n                      </select>\n                      <ng-container\n                        *ngTemplateOutlet=\"descTmp; context: { $implicit: feature.description }\"\n                      ></ng-container>\n                    </div>\n                  </ng-container>\n                </ng-container>\n                <ng-container *ngSwitchDefault>{{ feature.displayName }}</ng-container>\n              </div>\n            </ng-template>\n          </li>\n        </ul>\n      </div>\n\n      <ng-template #descTmp let-description>\n        <small *ngIf=\"description\" class=\"form-text text-muted\">{{ description }}</small>\n      </ng-template>\n\n      <div class=\"col-md-8\"><div [ngbNavOutlet]=\"nav\"></div></div>\n\n      <div class=\"mx-3\" *ngIf=\"!groups.length\">\n        {{ 'AbpFeatureManagement::NoFeatureFoundMessage' | abpLocalization }}\n      </div>\n    </div>\n  </ng-template>\n\n  <ng-template #abpFooter>\n    <button abpClose type=\"button\" class=\"btn btn-secondary\">\n      {{ 'AbpFeatureManagement::Cancel' | abpLocalization }}\n    </button>\n    <abp-button\n      *ngIf=\"groups.length\"\n      iconClass=\"fa fa-check\"\n      [disabled]=\"modalBusy\"\n      (click)=\"save()\"\n    >\n      {{ 'AbpFeatureManagement::Save' | abpLocalization }}\n    </abp-button>\n  </ng-template>\n</abp-modal>\n",
                exportAs: 'abpFeatureManagement'
            },] }
];
FeatureManagementComponent.ctorParameters = () => [
    { type: TrackByService },
    { type: FeaturesService },
    { type: Store },
    { type: ConfigStateService },
    { type: AbpApplicationConfigurationService }
];
FeatureManagementComponent.propDecorators = {
    providerKey: [{ type: Input }],
    providerName: [{ type: Input }],
    visible: [{ type: Input }],
    visibleChange: [{ type: Output }]
};
function mapFeatures(features, dir) {
    const margin = `margin-${dir === 'rtl' ? 'right' : 'left'}.px`;
    return features.map(feature => {
        var _a;
        const value = ((_a = feature.valueType) === null || _a === void 0 ? void 0 : _a.name) === ValueTypes.ToggleStringValueType
            ? (feature.value || '').toLowerCase() === 'true'
            : feature.value;
        return Object.assign(Object.assign({}, feature), { value, initialValue: value, style: { [margin]: feature.depth * 20 } });
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmVhdHVyZS1tYW5hZ2VtZW50LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2ZlYXR1cmUtbWFuYWdlbWVudC9zcmMvbGliL2NvbXBvbmVudHMvZmVhdHVyZS1tYW5hZ2VtZW50L2ZlYXR1cmUtbWFuYWdlbWVudC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGtDQUFrQyxFQUNsQyxrQkFBa0IsRUFDbEIsY0FBYyxHQUNmLE1BQU0sY0FBYyxDQUFDO0FBRXRCLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNwQyxPQUFPLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRS9DLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxpREFBaUQsQ0FBQztBQU9sRixJQUFLLFVBSUo7QUFKRCxXQUFLLFVBQVU7SUFDYiw2REFBK0MsQ0FBQTtJQUMvQyxpRUFBbUQsQ0FBQTtJQUNuRCxtRUFBcUQsQ0FBQTtBQUN2RCxDQUFDLEVBSkksVUFBVSxLQUFWLFVBQVUsUUFJZDtBQU9ELE1BQU0sT0FBTywwQkFBMEI7SUF1Q3JDLFlBQ2tCLEtBQXFCLEVBQzNCLE9BQXdCLEVBQ3hCLEtBQVksRUFDWixXQUErQixFQUMvQixnQkFBb0Q7UUFKOUMsVUFBSyxHQUFMLEtBQUssQ0FBZ0I7UUFDM0IsWUFBTyxHQUFQLE9BQU8sQ0FBaUI7UUFDeEIsVUFBSyxHQUFMLEtBQUssQ0FBTztRQUNaLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtRQUMvQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQW9DO1FBaENoRSxXQUFNLEdBQW9ELEVBQUUsQ0FBQztRQU03RCxlQUFVLEdBQUcsVUFBVSxDQUFDO1FBaUJMLGtCQUFhLEdBQUcsSUFBSSxZQUFZLEVBQVcsQ0FBQztRQUUvRCxjQUFTLEdBQUcsS0FBSyxDQUFDO0lBUWYsQ0FBQztJQXZCSixJQUNJLE9BQU87UUFDVCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdkIsQ0FBQztJQUVELElBQUksT0FBTyxDQUFDLEtBQWM7UUFDeEIsSUFBSSxJQUFJLENBQUMsUUFBUSxLQUFLLEtBQUs7WUFBRSxPQUFPO1FBRXBDLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQy9CLElBQUksS0FBSztZQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUM5QixDQUFDO0lBY0QsU0FBUztRQUNQLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQztTQUM5QztRQUVELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsRUFBRTs7WUFDcEUsSUFBSSxRQUFDLEdBQUcsQ0FBQyxNQUFNLDBDQUFFLE1BQU0sQ0FBQTtnQkFBRSxPQUFPO1lBQ2hDLElBQUksQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDakYsSUFBSSxDQUFDLHdCQUF3QixHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDO1lBQzNELElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQy9CLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsaUNBQ1QsR0FBRyxLQUNOLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBc0IsQ0FBQyxJQUMzRSxFQUNGLEVBQUUsQ0FDSCxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsSUFBSTtRQUNGLElBQUksSUFBSSxDQUFDLFNBQVM7WUFBRSxPQUFPO1FBRTNCLE1BQU0sZUFBZSxHQUFHLEVBQXdCLENBQUM7UUFFakQsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUNuQyxJQUFJLE9BQU8sQ0FBQyxLQUFLLEtBQUssT0FBTyxDQUFDLFlBQVk7b0JBQ3hDLGVBQWUsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzVFLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRTtZQUMzQixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztZQUNyQixPQUFPO1NBQ1I7UUFFRCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsT0FBTzthQUNULE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRSxRQUFRLEVBQUUsZUFBZSxFQUFFLENBQUM7YUFDMUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQzthQUM5QyxTQUFTLENBQUMsR0FBRyxFQUFFO1lBQ2QsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7WUFFckIsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7Z0JBQ3JCLDZCQUE2QjtnQkFDN0IsSUFBSSxDQUFDLGdCQUFnQjtxQkFDbEIsR0FBRyxFQUFFO3FCQUNMLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO3FCQUNoRCxTQUFTLEVBQUUsQ0FBQzthQUNoQjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELGVBQWUsQ0FBQyxHQUFZLEVBQUUsT0FBbUI7UUFDL0MsSUFBSSxHQUFHLEVBQUU7WUFDUCxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDcEM7YUFBTTtZQUNMLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUN4QztJQUNILENBQUM7SUFFTyx3QkFBd0IsQ0FBQyxPQUFtQjtRQUNsRCxJQUFJLENBQUMsMEJBQTBCLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUN4RixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FDbEMsQ0FBQztJQUNKLENBQUM7SUFFTyxvQkFBb0IsQ0FBQyxPQUFtQjtRQUM5QyxJQUFJLENBQUMsd0JBQXdCLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUN0RixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FDakMsQ0FBQztJQUNKLENBQUM7SUFFTyx3QkFBd0IsQ0FBQyxPQUFtQixFQUFFLElBQWdCO1FBQ3BFLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbEQsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLE9BQU8sTUFBTSxFQUFFO1lBQ2IsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN2QixNQUFNLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztTQUM5QztRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFTywwQkFBMEIsQ0FBQyxPQUFtQixFQUFFLElBQWdCO1FBQ3RFLE1BQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQztRQUN2QixNQUFNLEtBQUssR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXhCLE9BQU8sS0FBSyxDQUFDLE1BQU0sRUFBRTtZQUNuQixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDekIsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUMzRCxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsY0FBYyxDQUFDLENBQUM7WUFDcEMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLGNBQWMsQ0FBQyxDQUFDO1NBQy9CO1FBRUQsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUVPLGdCQUFnQixDQUFDLE9BQW1CLEVBQUUsSUFBZ0I7UUFDNUQsT0FBTyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsSUFBSSxDQUNoQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxLQUFLLElBQUksSUFBSSxDQUFDLENBQUMsSUFBSSxLQUFLLE9BQU8sQ0FBQyxVQUFVLENBQ2hFLENBQUM7SUFDSixDQUFDO0lBRU8sa0JBQWtCLENBQUMsT0FBbUIsRUFBRSxJQUFnQjtRQUM5RCxPQUFPLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxNQUFNLENBQ2xDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEtBQUssSUFBSSxJQUFJLENBQUMsQ0FBQyxVQUFVLEtBQUssT0FBTyxDQUFDLElBQUksQ0FDaEUsQ0FBQztJQUNKLENBQUM7SUFFTyxlQUFlOztRQUNyQixhQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLG1DQUFJLEVBQUUsQ0FBQztJQUM1RCxDQUFDO0lBRU8sZUFBZSxDQUFDLE9BQW1CLEVBQUUsR0FBWTtRQUN2RCxPQUFPLENBQUMsS0FBSyxHQUFHLEdBQVUsQ0FBQztJQUM3QixDQUFDOzs7WUEzS0YsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSx3QkFBd0I7Z0JBQ2xDLG1rS0FBa0Q7Z0JBQ2xELFFBQVEsRUFBRSxzQkFBc0I7YUFDakM7OztZQXhCQyxjQUFjO1lBT1AsZUFBZTtZQUhmLEtBQUs7WUFMWixrQkFBa0I7WUFEbEIsa0NBQWtDOzs7MEJBK0JqQyxLQUFLOzJCQUdMLEtBQUs7c0JBZUwsS0FBSzs0QkFhTCxNQUFNOztBQXNJVCxTQUFTLFdBQVcsQ0FBQyxRQUFzQixFQUFFLEdBQW9CO0lBQy9ELE1BQU0sTUFBTSxHQUFHLFVBQVUsR0FBRyxLQUFLLEtBQUssQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQztJQUUvRCxPQUFPLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUU7O1FBQzVCLE1BQU0sS0FBSyxHQUNULE9BQUEsT0FBTyxDQUFDLFNBQVMsMENBQUUsSUFBSSxNQUFLLFVBQVUsQ0FBQyxxQkFBcUI7WUFDMUQsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FBQyxXQUFXLEVBQUUsS0FBSyxNQUFNO1lBQ2hELENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO1FBRXBCLHVDQUNLLE9BQU8sS0FDVixLQUFLLEVBQ0wsWUFBWSxFQUFFLEtBQUssRUFDbkIsS0FBSyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRSxPQUFPLENBQUMsS0FBSyxHQUFHLEVBQUUsRUFBRSxJQUN2QztJQUNKLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFicEFwcGxpY2F0aW9uQ29uZmlndXJhdGlvblNlcnZpY2UsXG4gIENvbmZpZ1N0YXRlU2VydmljZSxcbiAgVHJhY2tCeVNlcnZpY2UsXG59IGZyb20gJ0BhYnAvbmcuY29yZSc7XG5pbXBvcnQgeyBMb2NhbGVEaXJlY3Rpb24gfSBmcm9tICdAYWJwL25nLnRoZW1lLnNoYXJlZCc7XG5pbXBvcnQgeyBDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3RvcmUgfSBmcm9tICdAbmd4cy9zdG9yZSc7XG5pbXBvcnQgeyBmaW5hbGl6ZSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRmVhdHVyZU1hbmFnZW1lbnQgfSBmcm9tICcuLi8uLi9tb2RlbHMvZmVhdHVyZS1tYW5hZ2VtZW50JztcbmltcG9ydCB7IEZlYXR1cmVzU2VydmljZSB9IGZyb20gJy4uLy4uL3Byb3h5L2ZlYXR1cmUtbWFuYWdlbWVudC9mZWF0dXJlcy5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIEZlYXR1cmVEdG8sXG4gIEZlYXR1cmVHcm91cER0byxcbiAgVXBkYXRlRmVhdHVyZUR0byxcbn0gZnJvbSAnLi4vLi4vcHJveHkvZmVhdHVyZS1tYW5hZ2VtZW50L21vZGVscyc7XG5cbmVudW0gVmFsdWVUeXBlcyB7XG4gIFRvZ2dsZVN0cmluZ1ZhbHVlVHlwZSA9ICdUb2dnbGVTdHJpbmdWYWx1ZVR5cGUnLFxuICBGcmVlVGV4dFN0cmluZ1ZhbHVlVHlwZSA9ICdGcmVlVGV4dFN0cmluZ1ZhbHVlVHlwZScsXG4gIFNlbGVjdGlvblN0cmluZ1ZhbHVlVHlwZSA9ICdTZWxlY3Rpb25TdHJpbmdWYWx1ZVR5cGUnLFxufVxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdhYnAtZmVhdHVyZS1tYW5hZ2VtZW50JyxcbiAgdGVtcGxhdGVVcmw6ICcuL2ZlYXR1cmUtbWFuYWdlbWVudC5jb21wb25lbnQuaHRtbCcsXG4gIGV4cG9ydEFzOiAnYWJwRmVhdHVyZU1hbmFnZW1lbnQnLFxufSlcbmV4cG9ydCBjbGFzcyBGZWF0dXJlTWFuYWdlbWVudENvbXBvbmVudFxuICBpbXBsZW1lbnRzXG4gICAgRmVhdHVyZU1hbmFnZW1lbnQuRmVhdHVyZU1hbmFnZW1lbnRDb21wb25lbnRJbnB1dHMsXG4gICAgRmVhdHVyZU1hbmFnZW1lbnQuRmVhdHVyZU1hbmFnZW1lbnRDb21wb25lbnRPdXRwdXRzIHtcbiAgQElucHV0KClcbiAgcHJvdmlkZXJLZXk6IHN0cmluZztcblxuICBASW5wdXQoKVxuICBwcm92aWRlck5hbWU6IHN0cmluZztcblxuICBzZWxlY3RlZEdyb3VwRGlzcGxheU5hbWU6IHN0cmluZztcblxuICBncm91cHM6IFBpY2s8RmVhdHVyZUdyb3VwRHRvLCAnbmFtZScgfCAnZGlzcGxheU5hbWUnPltdID0gW107XG5cbiAgZmVhdHVyZXM6IHtcbiAgICBbZ3JvdXA6IHN0cmluZ106IEFycmF5PEZlYXR1cmVEdG8gJiB7IHN0eWxlPzogeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfTsgaW5pdGlhbFZhbHVlOiBhbnkgfT47XG4gIH07XG5cbiAgdmFsdWVUeXBlcyA9IFZhbHVlVHlwZXM7XG5cbiAgcHJvdGVjdGVkIF92aXNpYmxlO1xuXG4gIEBJbnB1dCgpXG4gIGdldCB2aXNpYmxlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl92aXNpYmxlO1xuICB9XG5cbiAgc2V0IHZpc2libGUodmFsdWU6IGJvb2xlYW4pIHtcbiAgICBpZiAodGhpcy5fdmlzaWJsZSA9PT0gdmFsdWUpIHJldHVybjtcblxuICAgIHRoaXMuX3Zpc2libGUgPSB2YWx1ZTtcbiAgICB0aGlzLnZpc2libGVDaGFuZ2UuZW1pdCh2YWx1ZSk7XG4gICAgaWYgKHZhbHVlKSB0aGlzLm9wZW5Nb2RhbCgpO1xuICB9XG5cbiAgQE91dHB1dCgpIHJlYWRvbmx5IHZpc2libGVDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4+KCk7XG5cbiAgbW9kYWxCdXN5ID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHJlYWRvbmx5IHRyYWNrOiBUcmFja0J5U2VydmljZSxcbiAgICBwcm90ZWN0ZWQgc2VydmljZTogRmVhdHVyZXNTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBzdG9yZTogU3RvcmUsXG4gICAgcHJvdGVjdGVkIGNvbmZpZ1N0YXRlOiBDb25maWdTdGF0ZVNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGFwcENvbmZpZ1NlcnZpY2U6IEFicEFwcGxpY2F0aW9uQ29uZmlndXJhdGlvblNlcnZpY2UsXG4gICkge31cblxuICBvcGVuTW9kYWwoKSB7XG4gICAgaWYgKCF0aGlzLnByb3ZpZGVyTmFtZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdwcm92aWRlck5hbWUgaXMgcmVxdWlyZWQuJyk7XG4gICAgfVxuXG4gICAgdGhpcy5nZXRGZWF0dXJlcygpO1xuICB9XG5cbiAgZ2V0RmVhdHVyZXMoKSB7XG4gICAgdGhpcy5zZXJ2aWNlLmdldCh0aGlzLnByb3ZpZGVyTmFtZSwgdGhpcy5wcm92aWRlcktleSkuc3Vic2NyaWJlKHJlcyA9PiB7XG4gICAgICBpZiAoIXJlcy5ncm91cHM/Lmxlbmd0aCkgcmV0dXJuO1xuICAgICAgdGhpcy5ncm91cHMgPSByZXMuZ3JvdXBzLm1hcCgoeyBuYW1lLCBkaXNwbGF5TmFtZSB9KSA9PiAoeyBuYW1lLCBkaXNwbGF5TmFtZSB9KSk7XG4gICAgICB0aGlzLnNlbGVjdGVkR3JvdXBEaXNwbGF5TmFtZSA9IHRoaXMuZ3JvdXBzWzBdLmRpc3BsYXlOYW1lO1xuICAgICAgdGhpcy5mZWF0dXJlcyA9IHJlcy5ncm91cHMucmVkdWNlKFxuICAgICAgICAoYWNjLCB2YWwpID0+ICh7XG4gICAgICAgICAgLi4uYWNjLFxuICAgICAgICAgIFt2YWwubmFtZV06IG1hcEZlYXR1cmVzKHZhbC5mZWF0dXJlcywgZG9jdW1lbnQuYm9keS5kaXIgYXMgTG9jYWxlRGlyZWN0aW9uKSxcbiAgICAgICAgfSksXG4gICAgICAgIHt9LFxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHNhdmUoKSB7XG4gICAgaWYgKHRoaXMubW9kYWxCdXN5KSByZXR1cm47XG5cbiAgICBjb25zdCBjaGFuZ2VkRmVhdHVyZXMgPSBbXSBhcyBVcGRhdGVGZWF0dXJlRHRvW107XG5cbiAgICBPYmplY3Qua2V5cyh0aGlzLmZlYXR1cmVzKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICB0aGlzLmZlYXR1cmVzW2tleV0uZm9yRWFjaChmZWF0dXJlID0+IHtcbiAgICAgICAgaWYgKGZlYXR1cmUudmFsdWUgIT09IGZlYXR1cmUuaW5pdGlhbFZhbHVlKVxuICAgICAgICAgIGNoYW5nZWRGZWF0dXJlcy5wdXNoKHsgbmFtZTogZmVhdHVyZS5uYW1lLCB2YWx1ZTogYCR7ZmVhdHVyZS52YWx1ZX1gIH0pO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpZiAoIWNoYW5nZWRGZWF0dXJlcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMudmlzaWJsZSA9IGZhbHNlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMubW9kYWxCdXN5ID0gdHJ1ZTtcbiAgICB0aGlzLnNlcnZpY2VcbiAgICAgIC51cGRhdGUodGhpcy5wcm92aWRlck5hbWUsIHRoaXMucHJvdmlkZXJLZXksIHsgZmVhdHVyZXM6IGNoYW5nZWRGZWF0dXJlcyB9KVxuICAgICAgLnBpcGUoZmluYWxpemUoKCkgPT4gKHRoaXMubW9kYWxCdXN5ID0gZmFsc2UpKSlcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICB0aGlzLnZpc2libGUgPSBmYWxzZTtcblxuICAgICAgICBpZiAoIXRoaXMucHJvdmlkZXJLZXkpIHtcbiAgICAgICAgICAvLyB0byByZWZyZXNoIGhvc3QncyBmZWF0dXJlc1xuICAgICAgICAgIHRoaXMuYXBwQ29uZmlnU2VydmljZVxuICAgICAgICAgICAgLmdldCgpXG4gICAgICAgICAgICAucGlwZSh0YXAocmVzID0+IHRoaXMuY29uZmlnU3RhdGUuc2V0U3RhdGUocmVzKSkpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgb25DaGVja2JveENsaWNrKHZhbDogYm9vbGVhbiwgZmVhdHVyZTogRmVhdHVyZUR0bykge1xuICAgIGlmICh2YWwpIHtcbiAgICAgIHRoaXMuY2hlY2tUb2dnbGVBbmNlc3RvcnMoZmVhdHVyZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudW5jaGVja1RvZ2dsZURlc2NlbmRhbnRzKGZlYXR1cmUpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdW5jaGVja1RvZ2dsZURlc2NlbmRhbnRzKGZlYXR1cmU6IEZlYXR1cmVEdG8pIHtcbiAgICB0aGlzLmZpbmRBbGxEZXNjZW5kYW50c09mQnlUeXBlKGZlYXR1cmUsIFZhbHVlVHlwZXMuVG9nZ2xlU3RyaW5nVmFsdWVUeXBlKS5mb3JFYWNoKG5vZGUgPT5cbiAgICAgIHRoaXMuc2V0RmVhdHVyZVZhbHVlKG5vZGUsIGZhbHNlKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja1RvZ2dsZUFuY2VzdG9ycyhmZWF0dXJlOiBGZWF0dXJlRHRvKSB7XG4gICAgdGhpcy5maW5kQWxsQW5jZXN0b3JzT2ZCeVR5cGUoZmVhdHVyZSwgVmFsdWVUeXBlcy5Ub2dnbGVTdHJpbmdWYWx1ZVR5cGUpLmZvckVhY2gobm9kZSA9PlxuICAgICAgdGhpcy5zZXRGZWF0dXJlVmFsdWUobm9kZSwgdHJ1ZSksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZEFsbEFuY2VzdG9yc09mQnlUeXBlKGZlYXR1cmU6IEZlYXR1cmVEdG8sIHR5cGU6IFZhbHVlVHlwZXMpIHtcbiAgICBsZXQgcGFyZW50ID0gdGhpcy5maW5kUGFyZW50QnlUeXBlKGZlYXR1cmUsIHR5cGUpO1xuICAgIGNvbnN0IGFuY2VzdG9ycyA9IFtdO1xuICAgIHdoaWxlIChwYXJlbnQpIHtcbiAgICAgIGFuY2VzdG9ycy5wdXNoKHBhcmVudCk7XG4gICAgICBwYXJlbnQgPSB0aGlzLmZpbmRQYXJlbnRCeVR5cGUocGFyZW50LCB0eXBlKTtcbiAgICB9XG4gICAgcmV0dXJuIGFuY2VzdG9ycztcbiAgfVxuXG4gIHByaXZhdGUgZmluZEFsbERlc2NlbmRhbnRzT2ZCeVR5cGUoZmVhdHVyZTogRmVhdHVyZUR0bywgdHlwZTogVmFsdWVUeXBlcykge1xuICAgIGNvbnN0IGRlc2NlbmRhbnRzID0gW107XG4gICAgY29uc3QgcXVldWUgPSBbZmVhdHVyZV07XG5cbiAgICB3aGlsZSAocXVldWUubGVuZ3RoKSB7XG4gICAgICBjb25zdCBub2RlID0gcXVldWUucG9wKCk7XG4gICAgICBjb25zdCBuZXdEZXNjZW5kYW50cyA9IHRoaXMuZmluZENoaWxkcmVuQnlUeXBlKG5vZGUsIHR5cGUpO1xuICAgICAgZGVzY2VuZGFudHMucHVzaCguLi5uZXdEZXNjZW5kYW50cyk7XG4gICAgICBxdWV1ZS5wdXNoKC4uLm5ld0Rlc2NlbmRhbnRzKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVzY2VuZGFudHM7XG4gIH1cblxuICBwcml2YXRlIGZpbmRQYXJlbnRCeVR5cGUoZmVhdHVyZTogRmVhdHVyZUR0bywgdHlwZTogVmFsdWVUeXBlcykge1xuICAgIHJldHVybiB0aGlzLmdldEN1cnJlbnRHcm91cCgpLmZpbmQoXG4gICAgICBmID0+IGYudmFsdWVUeXBlLm5hbWUgPT09IHR5cGUgJiYgZi5uYW1lID09PSBmZWF0dXJlLnBhcmVudE5hbWUsXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZENoaWxkcmVuQnlUeXBlKGZlYXR1cmU6IEZlYXR1cmVEdG8sIHR5cGU6IFZhbHVlVHlwZXMpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRDdXJyZW50R3JvdXAoKS5maWx0ZXIoXG4gICAgICBmID0+IGYudmFsdWVUeXBlLm5hbWUgPT09IHR5cGUgJiYgZi5wYXJlbnROYW1lID09PSBmZWF0dXJlLm5hbWUsXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q3VycmVudEdyb3VwKCkge1xuICAgIHJldHVybiB0aGlzLmZlYXR1cmVzW3RoaXMuc2VsZWN0ZWRHcm91cERpc3BsYXlOYW1lXSA/PyBbXTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0RmVhdHVyZVZhbHVlKGZlYXR1cmU6IEZlYXR1cmVEdG8sIHZhbDogYm9vbGVhbikge1xuICAgIGZlYXR1cmUudmFsdWUgPSB2YWwgYXMgYW55O1xuICB9XG59XG5cbmZ1bmN0aW9uIG1hcEZlYXR1cmVzKGZlYXR1cmVzOiBGZWF0dXJlRHRvW10sIGRpcjogTG9jYWxlRGlyZWN0aW9uKSB7XG4gIGNvbnN0IG1hcmdpbiA9IGBtYXJnaW4tJHtkaXIgPT09ICdydGwnID8gJ3JpZ2h0JyA6ICdsZWZ0J30ucHhgO1xuXG4gIHJldHVybiBmZWF0dXJlcy5tYXAoZmVhdHVyZSA9PiB7XG4gICAgY29uc3QgdmFsdWUgPVxuICAgICAgZmVhdHVyZS52YWx1ZVR5cGU/Lm5hbWUgPT09IFZhbHVlVHlwZXMuVG9nZ2xlU3RyaW5nVmFsdWVUeXBlXG4gICAgICAgID8gKGZlYXR1cmUudmFsdWUgfHwgJycpLnRvTG93ZXJDYXNlKCkgPT09ICd0cnVlJ1xuICAgICAgICA6IGZlYXR1cmUudmFsdWU7XG5cbiAgICByZXR1cm4ge1xuICAgICAgLi4uZmVhdHVyZSxcbiAgICAgIHZhbHVlLFxuICAgICAgaW5pdGlhbFZhbHVlOiB2YWx1ZSxcbiAgICAgIHN0eWxlOiB7IFttYXJnaW5dOiBmZWF0dXJlLmRlcHRoICogMjAgfSxcbiAgICB9O1xuICB9KTtcbn1cbiJdfQ==